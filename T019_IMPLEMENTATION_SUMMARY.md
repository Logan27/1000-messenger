# T019 Implementation Summary: Define Prisma Schema

## Task Overview
Task T019 focuses on defining the complete Prisma schema in `backend/prisma/schema.prisma` with all 9 entities required for the messenger application.

## Implementation Details

### Schema Location
- **File**: `backend/prisma/schema.prisma`
- **Database**: PostgreSQL 15+
- **ORM**: Prisma 5+
- **Generated Client Output**: `backend/src/generated/prisma`

### Entities Implemented (9 total)

1. **User** → `users` table
   - User accounts and authentication
   - Fields: id, username, passwordHash, displayName, avatarUrl, status, lastSeen, createdAt, updatedAt
   - Indexes on: username, status, lastSeen, createdAt

2. **Contact** → `contacts` table
   - Bidirectional contact relationships
   - Fields: id, userId, contactId, status, requestedBy, createdAt, acceptedAt
   - Unique constraint on (userId, contactId) pair
   - Indexes on: (userId, status), (contactId, status)

3. **Chat** → `chats` table
   - Direct and group chat rooms
   - Fields: id, type, name, slug, avatarUrl, ownerId, createdAt, updatedAt, lastMessageAt, isDeleted
   - Unique constraint on slug
   - Indexes on: type, slug, ownerId, lastMessageAt

4. **ChatParticipant** → `chat_participants` table
   - Chat membership tracking
   - Fields: id, chatId, userId, role, joinedAt, leftAt
   - Unique constraint on (chatId, userId) pair
   - Indexes on: (chatId, leftAt), (userId, leftAt), (chatId, joinedAt)

5. **Message** → `messages` table
   - Chat messages with content and metadata
   - Fields: id, chatId, senderId, content, contentType, metadata (JSONB), replyToId, isEdited, editedAt, isDeleted, deletedAt, createdAt
   - Self-referencing relationship for message replies
   - Indexes on: (chatId, createdAt), (senderId, createdAt), replyToId

6. **Attachment** → `attachments` table
   - Image/file attachments for messages
   - Fields: id, messageId, fileName, fileType, fileSize, storageKey, thumbnailKey, url, thumbnailUrl, width, height, createdAt
   - Indexes on: messageId, createdAt

7. **MessageReaction** → `message_reactions` table
   - Emoji reactions to messages
   - Fields: id, messageId, userId, emoji, createdAt
   - Unique constraint on (messageId, userId, emoji)
   - Indexes on: (messageId, emoji), (userId, createdAt)

8. **MessageDelivery** → `message_delivery` table
   - Delivery and read status tracking
   - Fields: id, messageId, userId, status, deliveredAt, readAt, createdAt
   - Unique constraint on (messageId, userId) pair
   - Indexes on: (messageId, status), (userId, status), (userId, createdAt)

9. **UnreadMessage** → `unread_messages` table
   - Fast unread message count lookups
   - Fields: id, userId, chatId, messageId, createdAt
   - Unique constraint on (userId, chatId, messageId)
   - Indexes on: (userId, chatId), (userId, createdAt), (chatId, userId)

### Key Design Decisions

1. **UUID Primary Keys**: All entities use UUID v4 generated by PostgreSQL (`gen_random_uuid()`)
2. **Snake Case Mapping**: Model fields use camelCase but map to snake_case database columns via `@map()`
3. **Cascade Deletes**: Appropriate use of `onDelete: Cascade` for dependent entities and `onDelete: SetNull` for optional references
4. **Soft Deletes**: Chat and Message entities use `isDeleted` flags instead of hard deletes
5. **Timestamps**: All entities have `createdAt`, many have `updatedAt` with auto-update
6. **JSONB Metadata**: Messages use JSONB for flexible metadata storage
7. **Bidirectional Relations**: Proper Prisma relation definitions with named relations where needed

### Relations Summary

- **User**: Has many contacts (3 relations), owned chats, chat participations, sent messages, reactions, deliveries, unread messages
- **Contact**: Belongs to user, contact user, and requested-by user (3 foreign keys to users)
- **Chat**: Belongs to owner (optional), has many participants, messages, unread messages
- **ChatParticipant**: Belongs to chat and user
- **Message**: Belongs to chat and sender (optional), has self-reference for replies, has many attachments, reactions, deliveries, unread messages
- **Attachment**: Belongs to message
- **MessageReaction**: Belongs to message and user
- **MessageDelivery**: Belongs to message and user
- **UnreadMessage**: Belongs to user, chat, and message

### Validation Status

✅ Schema is syntactically valid (verified with `npx prisma validate`)
✅ Schema is properly formatted (verified with `npx prisma format`)
✅ All 9 required entities are present
✅ All table names match requirements
✅ All relationships are properly defined

## Files Modified

- `backend/prisma/schema.prisma` - Complete schema with all 9 entities

## Next Steps

The following tasks will build upon this schema:

- **T020**: Create initial database migration
- **T021**: Setup database configuration for connection pooling
- Future repository and service implementations will use this schema

## Verification Commands

```bash
# Validate schema
cd backend
DATABASE_URL="postgresql://user:pass@localhost:5432/db" npx prisma validate

# Format schema
DATABASE_URL="postgresql://user:pass@localhost:5432/db" npx prisma format

# Count models
grep -c "^model " prisma/schema.prisma  # Should output: 9

# List all models
grep "^model " prisma/schema.prisma

# List all table mappings
grep "@@map" prisma/schema.prisma
```

## Notes

- The `prisma.config.ts` file has a non-standard import (`prisma/config`) which doesn't affect the schema itself but may need addressing in future tasks
- Partial indexes (with WHERE clauses) are not supported in Prisma's @@index syntax, so standard indexes are used instead
- For production optimization, partial indexes can be added via raw SQL migrations after the initial migration is created
